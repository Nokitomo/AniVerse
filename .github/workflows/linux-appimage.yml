name: Linux AppImage Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Linux build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libpulse-dev file binutils

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Build Linux (release)
        run: flutter build linux --release

      - name: Install AppImage Builder
        run: |
          sudo apt-get install -y libfuse2 python3-pip
          pip3 install appimage-builder

      - name: Update AppImageBuilder version
        run: |
          VERSION_LINE=$(grep '^version:' pubspec.yaml | head -n 1 | cut -d' ' -f2)
          BASE_VERSION=$(echo "$VERSION_LINE" | cut -d'+' -f1)
          sed -i "s/^    version:.*/    version: $BASE_VERSION/" AppImageBuilder.yml

      - name: Build AppImage
        env:
          APPIMAGEBUILDER_ARCH: x86_64
          ARCH: x86_64
          APPIMAGE_ARCH: x86_64
          APPIMAGEBUILDER_DISABLE_APPRUN2: "1"
        run: appimage-builder --recipe AppImageBuilder.yml --skip-test

      - name: Rename AppImage assets
        run: |
          APPIMAGE=$(ls *.AppImage | head -n 1)
          ZSYNC=$(ls *.zsync | head -n 1)
          mv "$APPIMAGE" AniVerse-x86_64.AppImage
          mv "$ZSYNC" AniVerse-x86_64.AppImage.zsync

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: AniVerse-linux-appimage
          path: |
            AniVerse-x86_64.AppImage
            AniVerse-x86_64.AppImage.zsync

      - name: Publish GitHub Release (tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          files: |
            AniVerse-x86_64.AppImage
            AniVerse-x86_64.AppImage.zsync
